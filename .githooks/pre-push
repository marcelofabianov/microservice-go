#!/bin/bash
#
# Pre-push hook para garantir qualidade completa antes do push
# Executa anÃ¡lise completa de qualidade e seguranÃ§a
#

set -e

# Cores para output
COLOR_RESET='\033[0m'
COLOR_BOLD='\033[1m'
COLOR_GREEN='\033[32m'
COLOR_YELLOW='\033[33m'
COLOR_RED='\033[31m'
COLOR_BLUE='\033[34m'

echo -e "${COLOR_BOLD}${COLOR_BLUE}ðŸš€ Pre-push: VerificaÃ§Ã£o completa antes do push...${COLOR_RESET}\n"

# Verifica se hÃ¡ containers rodando
if ! docker compose ps | grep -q "Up"; then
    echo -e "${COLOR_RED}âœ— Containers nÃ£o estÃ£o rodando!${COLOR_RESET}"
    echo -e "${COLOR_YELLOW}ðŸ’¡ Execute 'make up' primeiro${COLOR_RESET}"
    exit 1
fi

# 1. Linting completo
echo -e "${COLOR_BLUE}1ï¸âƒ£  Executando linter completo...${COLOR_RESET}"
if ! docker compose exec -T api golangci-lint run ./... --timeout=5m; then
    echo -e "${COLOR_RED}âœ— Linting falhou!${COLOR_RESET}"
    echo -e "${COLOR_YELLOW}ðŸ’¡ Dica: Execute 'make lint-verbose' para detalhes${COLOR_RESET}"
    exit 1
fi
echo -e "${COLOR_GREEN}âœ“ Linting aprovado${COLOR_RESET}\n"

# 2. Testes completos com cobertura
echo -e "${COLOR_BLUE}2ï¸âƒ£  Executando testes completos...${COLOR_RESET}"
if ! docker compose exec -T api go test -v -coverprofile=coverage.out ./... > /dev/null 2>&1; then
    echo -e "${COLOR_RED}âœ— Testes falharam!${COLOR_RESET}"
    echo -e "${COLOR_YELLOW}ðŸ’¡ Dica: Execute 'make test' para detalhes${COLOR_RESET}"
    exit 1
fi

# Verificar cobertura mÃ­nima (opcional - 70%)
COVERAGE=$(docker compose exec -T api go tool cover -func=coverage.out | grep total | awk '{print $3}' | sed 's/%//')
if (( $(echo "$COVERAGE < 70" | bc -l) )); then
    echo -e "${COLOR_YELLOW}âš  Cobertura de testes abaixo de 70%: ${COVERAGE}%${COLOR_RESET}"
    echo -e "${COLOR_YELLOW}ðŸ’¡ Considere adicionar mais testes${COLOR_RESET}"
else
    echo -e "${COLOR_GREEN}âœ“ Testes aprovados (cobertura: ${COVERAGE}%)${COLOR_RESET}"
fi
echo ""

# 3. AnÃ¡lise de seguranÃ§a
echo -e "${COLOR_BLUE}3ï¸âƒ£  Executando anÃ¡lise de seguranÃ§a...${COLOR_RESET}"
if ! docker compose exec -T api gosec -quiet ./... > /dev/null 2>&1; then
    echo -e "${COLOR_YELLOW}âš  PossÃ­veis problemas de seguranÃ§a detectados${COLOR_RESET}"
    echo -e "${COLOR_YELLOW}ðŸ’¡ Execute 'make security-check' para detalhes${COLOR_RESET}"
    # NÃ£o bloqueia push, apenas avisa
else
    echo -e "${COLOR_GREEN}âœ“ AnÃ¡lise de seguranÃ§a aprovada${COLOR_RESET}"
fi
echo ""

# 4. Verificar vulnerabilidades conhecidas
echo -e "${COLOR_BLUE}4ï¸âƒ£  Verificando vulnerabilidades conhecidas...${COLOR_RESET}"
if docker compose exec -T api govulncheck ./... > /dev/null 2>&1; then
    echo -e "${COLOR_GREEN}âœ“ Nenhuma vulnerabilidade conhecida detectada${COLOR_RESET}"
else
    echo -e "${COLOR_YELLOW}âš  Vulnerabilidades detectadas${COLOR_RESET}"
    echo -e "${COLOR_YELLOW}ðŸ’¡ Execute 'make security-check' para detalhes${COLOR_RESET}"
    # NÃ£o bloqueia push, apenas avisa
fi
echo ""

# 5. Verificar mod tidy
echo -e "${COLOR_BLUE}5ï¸âƒ£  Verificando go.mod e go.sum...${COLOR_RESET}"
docker compose exec -T api go mod tidy
if ! git diff --exit-code go.mod go.sum > /dev/null 2>&1; then
    echo -e "${COLOR_RED}âœ— go.mod ou go.sum nÃ£o estÃ£o atualizados!${COLOR_RESET}"
    echo -e "${COLOR_YELLOW}ðŸ’¡ Execute 'make mod-tidy' e commit as alteraÃ§Ãµes${COLOR_RESET}"
    exit 1
fi
echo -e "${COLOR_GREEN}âœ“ go.mod e go.sum atualizados${COLOR_RESET}\n"

echo -e "${COLOR_BOLD}${COLOR_GREEN}âœ… Pre-push: Todas as verificaÃ§Ãµes passaram! Push permitido.${COLOR_RESET}\n"
exit 0
