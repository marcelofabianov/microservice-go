#!/bin/bash
#
# Pre-commit hook para garantir qualidade do c√≥digo
# Executa formata√ß√£o, linting e testes r√°pidos
#

set -e

# Cores para output
COLOR_RESET='\033[0m'
COLOR_BOLD='\033[1m'
COLOR_GREEN='\033[32m'
COLOR_YELLOW='\033[33m'
COLOR_RED='\033[31m'
COLOR_BLUE='\033[34m'

echo -e "${COLOR_BOLD}${COLOR_BLUE}üîç Pre-commit: Verificando qualidade do c√≥digo...${COLOR_RESET}\n"

# Verifica se h√° arquivos Go staged
STAGED_GO_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.go$' || true)

if [ -z "$STAGED_GO_FILES" ]; then
    echo -e "${COLOR_YELLOW}‚ö† Nenhum arquivo Go modificado, pulando verifica√ß√µes${COLOR_RESET}"
    exit 0
fi

echo -e "${COLOR_BLUE}üìù Arquivos Go modificados:${COLOR_RESET}"
echo "$STAGED_GO_FILES"
echo ""

# 1. Formata√ß√£o autom√°tica
echo -e "${COLOR_BLUE}1Ô∏è‚É£  Formatando c√≥digo...${COLOR_RESET}"
if ! docker compose exec -T api gofumpt -l -w .; then
    echo -e "${COLOR_RED}‚úó Erro ao formatar c√≥digo${COLOR_RESET}"
    exit 1
fi
echo -e "${COLOR_GREEN}‚úì C√≥digo formatado${COLOR_RESET}\n"

# 2. Imports organizados
echo -e "${COLOR_BLUE}2Ô∏è‚É£  Organizando imports...${COLOR_RESET}"
if ! docker compose exec -T api goimports -w .; then
    echo -e "${COLOR_RED}‚úó Erro ao organizar imports${COLOR_RESET}"
    exit 1
fi
echo -e "${COLOR_GREEN}‚úì Imports organizados${COLOR_RESET}\n"

# 3. Linting apenas em c√≥digo novo
echo -e "${COLOR_BLUE}3Ô∏è‚É£  Executando linter em c√≥digo novo...${COLOR_RESET}"
if ! docker compose exec -T api golangci-lint run ./... --new --timeout=3m; then
    echo -e "${COLOR_RED}‚úó Linting falhou! Corrija os problemas antes de commitar.${COLOR_RESET}"
    echo -e "${COLOR_YELLOW}üí° Dica: Execute 'make lint-fix' para corre√ß√µes autom√°ticas${COLOR_RESET}"
    exit 1
fi
echo -e "${COLOR_GREEN}‚úì Linting aprovado${COLOR_RESET}\n"

# 4. Testes r√°pidos (apenas pacotes modificados)
echo -e "${COLOR_BLUE}4Ô∏è‚É£  Executando testes r√°pidos...${COLOR_RESET}"
if ! docker compose exec -T api go test -short ./... > /dev/null 2>&1; then
    echo -e "${COLOR_RED}‚úó Testes falharam! Corrija antes de commitar.${COLOR_RESET}"
    echo -e "${COLOR_YELLOW}üí° Dica: Execute 'make test' para detalhes${COLOR_RESET}"
    exit 1
fi
echo -e "${COLOR_GREEN}‚úì Testes aprovados${COLOR_RESET}\n"

# 5. Re-adicionar arquivos formatados ao stage
echo -e "${COLOR_BLUE}5Ô∏è‚É£  Atualizando stage com arquivos formatados...${COLOR_RESET}"
for file in $STAGED_GO_FILES; do
    git add "$file"
done
echo -e "${COLOR_GREEN}‚úì Stage atualizado${COLOR_RESET}\n"

echo -e "${COLOR_BOLD}${COLOR_GREEN}‚úÖ Pre-commit: Todas as verifica√ß√µes passaram!${COLOR_RESET}\n"
exit 0
